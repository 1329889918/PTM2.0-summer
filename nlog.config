<nlog xmlns="http://www.nlog-project.org/schemas/NLog.xsd"
      xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
      autoReload="true"
      throwConfigExceptions="true"
      internalLogLevel="Off">

    <targets>
        <!-- 异步数据库目标（原始SQL但优化） -->
        <target name="asyncDb" xsi:type="AsyncWrapper"
                queueLimit="5000" overflowAction="Discard"
                batchSize="50" timeToSleepBetweenBatches="20">
            <target xsi:type="Database"
                    dbProvider="System.Data.SqlClient.SqlConnection,System.Data.SqlClient"
                    connectionString="Data Source=YJL;Initial Catalog=ASPCore;Integrated Security=True"
                    keepConnection="true" >
                <!-- 保持连接避免重复握手 -->
                <commandText>
                    INSERT INTO dbo.Log(Log_Machine, Log_Date, Log_Level, Log_Message, Logger)
                    VALUES (@Machine, @Date, @Level, @Message, @Logger);
                </commandText>
                <parameter name="@Machine" layout="${machinename}" size="50"/>
                <parameter name="@Date" layout="${date}" />
                <parameter name="@Level" layout="${level}" size="10"/>
                <parameter name="@Message" layout="${message}" size="4000"/>
                <parameter name="@Logger" layout="${logger}" size="255"/>
            </target>
        </target>
    </targets>

    <rules>
        <!-- 只记录警告及以上日志 -->
        <logger name="*" minlevel="Warn" writeTo="asyncDb" />
    </rules>
</nlog>